{% comment %}
  This section is used in the product template to render product page with
  media, content, and add-to-cart form.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/product
{% endcomment %}

{{ 'product.css' | asset_url | stylesheet_tag }}
<script src="{{ 'variant-picker.js' | asset_url }}" defer></script>
<script src="{{ 'quantity-selector.js' | asset_url }}" defer></script>

<script>
  // Product data for variant and media handling
  window.productData = {{ product | json }};
  
  // Create variant to media mapping using product JSON
  window.variantMediaMapping = {};
  
  // Build media ID to index mapping
  const mediaIndexMap = {};
  window.productData.media.forEach((media, index) => {
    mediaIndexMap[media.id] = index;
  });
  
  // Build variant to media mapping
  window.productData.variants.forEach(variant => {
    window.variantMediaMapping[variant.id] = {
      mediaId: variant.featured_media ? variant.featured_media.id : null,
      slideIndex: variant.featured_media ? mediaIndexMap[variant.featured_media.id] || 0 : 0
    };
  });
</script>

<section class="uk-section uk-section-default">
  <div class="uk-container">
    <div class="uk-grid uk-grid-large uk-child-width-1-1 uk-child-width-1-2@m" uk-grid>
      <div>
        <div class="uk-card uk-card-default uk-card-body uk-padding-remove product-images">
          {%- if product.media.size > 1 -%}
            <!-- Main Image Slider -->
            <div class="uk-position-relative uk-visible-toggle uk-light uk-slider uk-slider-container" tabindex="-1" uk-slider="ratio: 1:1;" data-product-gallery>
              <ul class="uk-slider-items uk-child-width-1-1">
                {%- for media in product.media -%}
                  <li data-media-id="{{ media.id }}" {% if product.selected_or_first_available_variant.featured_media.id == media.id %}data-variant-media="true"{% endif %}>
                    {%- case media.media_type -%}
                      {%- when 'image' -%}
                        {% liquid
                          if forloop.first
                            assign loading = 'high'
                          else
                            assign loading = 'lazy'
                            endif
                          %}
                        {% render 'image', 
                            image: media.preview_image,
                            image_class: "uk-width-1-1 uk-border-rounded product-image",
                            max_width: 800,
                            max_height: 800,
                            sizes: "(min-width: 1200px) 600px, (min-width: 768px) 50vw, 100vw",
                            widths: "400, 600, 800, 1000",
                            loading: loading,
                            attributes: 'alt="{{ media.alt | default: product.title }}"'
                        %}
                      {%- when 'video' -%}
                        <div class="uk-inline uk-width-1-1">
                          {{ media | video_tag: image_size: "1000x1000", loop: true, controls: true, muted: true, class: "uk-width-1-1 uk-border-rounded" }}
                        </div>
                      {%- when 'external_video' -%}
                        <div class="uk-inline uk-width-1-1">
                          {{ media | external_video_tag: image_size: "1000x1000", loop: true, controls: true, muted: true, class: "uk-width-1-1 uk-border-rounded" }}
                        </div>
                      {%- when 'model' -%}
                        <div class="uk-inline uk-width-1-1">
                          {{ media | model_viewer_tag: image_size: "1000x1000", reveal: "interaction", toggleable: true, class: "uk-width-1-1 uk-border-rounded" }}
                        </div>
                    {%- endcase -%}
                  </li>
                {%- endfor -%}
              </ul>
              
              <!-- Navigation arrows -->
              <a class="uk-position-center-left uk-position-small uk-hidden-hover" href="#" uk-slidenav-previous uk-slider-item="previous"></a>
              <a class="uk-position-center-right uk-position-small uk-hidden-hover" href="#" uk-slidenav-next uk-slider-item="next"></a>
            </div>

            <!-- Thumbnail Navigation -->
            {%- if product.media.size > 1 -%}
            <div class="uk-margin-small-top">
              <div class="uk-position-relative uk-visible-toggle uk-light uk-slider uk-slider-container" tabindex="-1" uk-slider="center: true; ratio: 1:1;" data-product-thumbnails>
                <ul class="uk-slider-items uk-child-width-1-5 uk-child-width-1-6@s uk-grid-small" uk-grid>
                  {%- for media in product.media -%}
                    <li uk-slider-item="{{ forloop.index0 }}" data-media-id="{{ media.id }}" style="aspect-ratio: 1/1;">
                      <a href="#" class="uk-inline uk-border-rounded {% if product.selected_or_first_available_variant.featured_media.id == media.id %}uk-box-shadow-large{% endif %}" uk-slider-parallax="scale: 0.8,1,0.8" onclick="UIkit.slider('[data-product-gallery]').show({{ forloop.index0 }}); return false;" data-thumbnail-link="{{ forloop.index0 }}">
                        {%- case media.media_type -%}
                          {%- when 'image' -%}
                            {% render 'image', 
                                image: media.preview_image,
                                image_class: "uk-width-1-1 uk-border-rounded",
                                max_width: 200,
                                max_height: 200,
                                sizes: "100px",
                                widths: "100, 150, 200",
                                loading: 'lazy',
                                attributes: 'alt="{{ media.alt | default: product.title }}"'
                            %}
                          {%- when 'video' -%}
                            <div class="uk-position-relative">
                              {% render 'image', 
                                  image: media.preview_image,
                                  image_class: "uk-width-1-1 uk-border-rounded",
                                  max_width: 200,
                                  max_height: 200,
                                  sizes: "100px",
                                  widths: "100, 150, 200",
                                  loading: 'high',
                                  attributes: 'alt="{{ media.alt | default: product.title }}"'
                              %}
                              <div class="uk-position-center">
                                <div class="uk-border-circle uk-background-primary" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                  <span uk-icon="icon: play; ratio: 0.7" class="uk-text-white"></span>
                                </div>
                              </div>
                            </div>
                          {%- when 'external_video' -%}
                            <div class="uk-position-relative">
                              {% render 'image', 
                                  image: media.preview_image,
                                  image_class: "uk-width-1-1 uk-border-rounded",
                                  max_width: 200,
                                  max_height: 200,
                                  sizes: "100px",
                                  widths: "100, 150, 200",
                                  loading: 'lazy',
                                  attributes: 'alt="{{ media.alt | default: product.title }}"'
                              %}
                              <div class="uk-position-center">
                                <div class="uk-border-circle uk-background-primary" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                  <span uk-icon="icon: play; ratio: 0.7" class="uk-text-white"></span>
                                </div>
                              </div>
                            </div>
                          {%- when 'model' -%}
                            <div class="uk-position-relative">
                              {% render 'image', 
                                  image: media.preview_image,
                                  image_class: "uk-width-1-1 uk-border-rounded",
                                  max_width: 200,
                                  max_height: 200,
                                  sizes: "100px",
                                  widths: "100, 150, 200",
                                  loading: 'lazy',
                                  attributes: 'alt="{{ media.alt | default: product.title }}"'
                              %}
                              <div class="uk-position-center">
                                <div class="uk-border-circle uk-background-primary" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                  <span uk-icon="icon: 3d-rotation; ratio: 0.7" class="uk-text-white"></span>
                                </div>
                              </div>
                            </div>
                        {%- endcase -%}
                      </a>
                    </li>
                  {%- endfor -%}
                </ul>
                
                <!-- Thumbnail navigation arrows -->
                {%- if product.media.size > 6 -%}
                <a class="uk-position-center-left uk-position-small uk-hidden-hover" href="#" uk-slidenav-previous uk-slider-item="previous"></a>
                <a class="uk-position-center-right uk-position-small uk-hidden-hover" href="#" uk-slidenav-next uk-slider-item="next"></a>
                {%- endif -%}
              </div>
            </div>
            {%- endif -%}
          {%- else -%}
            <!-- Single Image/Media -->
            {%- assign current_media = product.selected_or_first_available_variant.featured_media | default: product.media.first -%}
            {%- case current_media.media_type -%}
              {%- when 'image' -%}
                {% render 'image', 
                    image: current_media.preview_image,
                    image_class: "uk-width-1-1 uk-border-rounded product-image",
                    max_width: 1000,
                    max_height: 1000,
                    sizes: "(min-width: 1200px) 600px, (min-width: 768px) 50vw, 100vw",
                    widths: "400, 600, 800, 1000",
                    loading: 'eager',
                    attributes: 'alt="{{ current_media.alt | default: product.title }}"'
                %}
              {%- when 'video' -%}
                {{ current_media | video_tag: image_size: "1000x1000", loop: true, controls: true, muted: true, class: "uk-width-1-1 uk-border-rounded" }}
              {%- when 'external_video' -%}
                {{ current_media | external_video_tag: image_size: "1000x1000", loop: true, controls: true, muted: true, class: "uk-width-1-1 uk-border-rounded" }}
              {%- when 'model' -%}
                {{ current_media | model_viewer_tag: image_size: "1000x1000", reveal: "interaction", toggleable: true, class: "uk-width-1-1 uk-border-rounded" }}
            {%- endcase -%}
          {%- endif -%}
        </div>
      </div>
      <div>
        <div class="uk-card uk-card-default uk-card-body">
        {% form 'product', product, class: 'uk-form-stacked' %}
          <div class="uk-grid uk-grid-medium uk-child-width-1-1 product-content" uk-grid>
        {% for block in section.blocks %}
          {% case block.type %}
            {% when 'title' %}
              <div>
                <h1 class="uk-heading-small uk-margin-remove-top">{{ product.title }}</h1>
              </div>

            {% when 'price' %}
              <div>
                <div class="uk-flex uk-flex-middle uk-grid-small" uk-grid>
                  {% if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price %}
                    <div class="uk-width-auto">
                      <span class="uk-text-large uk-text-bold uk-text-danger">{{ product.selected_or_first_available_variant.price | money }}</span>
                    </div>
                    <div class="uk-width-auto">
                      <span class="uk-text-muted uk-text-decoration-line-through">{{ product.selected_or_first_available_variant.compare_at_price | money }}</span>
                    </div>
                  {% else %}
                    <div class="uk-width-auto">
                      <span class="uk-text-large uk-text-bold">{{ product.selected_or_first_available_variant.price | money }}</span>
                    </div>
                  {% endif %}
                </div>
              </div>

            {% when 'inventory' %}
              <div>
                <span class="uk-text-small uk-text-muted">Inventory: {{ product.selected_or_first_available_variant.inventory_quantity }}</span>
              </div>

            {% when 'add_to_cart' %}
              <div>
                <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                <input type="hidden" name="quantity" value="1">
                <button 
                  type="submit" 
                  class="uk-button uk-button-primary uk-button-large uk-width-1-1 {% unless product.selected_or_first_available_variant.available %}uk-disabled{% endunless %}"
                  {% unless product.selected_or_first_available_variant.available %}
                    disabled
                  {% endunless %}
                >
                  {% if product.selected_or_first_available_variant.available %}
                    Add to cart
                  {% else %}
                    Sold out
                  {% endif %}
                </button>
              </div>

            {%  when 'variant_picker' %}
              <div>
                {%- unless product.has_only_default_variant -%}
                  <variant-selector class="uk-margin-medium-bottom product-content__variants" data-section-id="{{ section.id }}">
                    {% for option in product.options_with_values %}
                      <fieldset class="uk-fieldset uk-margin">
                        <legend class="uk-legend uk-text-bold">
                          {{ option.name }}
                        </legend>
                        <div class="uk-grid uk-grid-small uk-child-width-auto" uk-grid>
                          {% for value in option.values %}
                            {% if option.name == "Color" %}
                              <div>
                                {% if value.swatch.color %}
                                  <input id="{{ option.name }}-{{ value }}" type="radio" name="{{ option.name }}" value="{{ value.variant.id }}" {% if option.selected_value == value %}checked{% endif %} class="uk-radio uk-hidden">
                                  <label for="{{ option.name }}-{{ value }}" class="uk-button uk-button-default uk-border-rounded color-swatch {% unless value.variant.available %}uk-disabled{% endunless %}" style="background-color: {{ value.swatch.color }}; width: 40px; height: 40px; padding: 0;"></label>
                                {% else %}
                                  <input id="{{ option.name }}-{{ value }}" type="radio" name="{{ option.name }}" value="{{ value.variant.id }}" {% if option.selected_value == value %}checked{% endif %} class="uk-radio uk-hidden">
                                  <label for="{{ option.name }}-{{ value }}" class="uk-button uk-button-default uk-border-rounded color-swatch {% unless value.variant.available %}uk-disabled{% endunless %}" style="background-image: url({{ value.swatch.image | image_url: width: 100 }}); width: 40px; height: 40px; padding: 0; background-size: cover;"></label>
                                {% endif %}
                              </div>
                            {% else %}
                              <div>
                                <input id="{{ option.name }}-{{ value }}" type="radio" name="{{ option.name }}" value="{{ value.variant.id }}" {% if option.selected_value == value %}checked{% endif %} class="uk-radio uk-hidden">
                                <label for="{{ option.name }}-{{ value }}" class="uk-button uk-button-default {% unless value.variant.available %}uk-disabled{% endunless %}">{{ value }}</label>
                              </div>
                            {% endif %}
                          {% endfor %}
                        </div>
                    </fieldset>
                  {% endfor %}
                </variant-selector>
              {%- endunless -%}
              </div>

            {% when 'quantity_selector' %}
              <div>
                {% comment %} 
                  This is not part of the video but I added it to the project to make the quantity selector work with the variant picker.
                  Be ware though that this is not a production ready solution and may not work for all cases. 
                {% endcomment %}
  
                <quantity-selector class="uk-flex uk-flex-middle uk-grid-small quantity-selector" uk-grid data-max="{{ product.selected_or_first_available_variant.inventory_quantity }}">
                  <div class="uk-width-auto">
                    <button type="button" class="uk-button uk-button-default quantity-selector__button" data-quantity-minus>-</button>
                  </div>
                  <div class="uk-width-auto">
                    <span class="uk-text-bold uk-padding-small quantity-selector__value" data-quantity-display>1</span>
                  </div>
                  <div class="uk-width-auto">
                    <button type="button" class="uk-button uk-button-default quantity-selector__button" data-quantity-plus>+</button>
                  </div>
                </quantity-selector>
              </div>
          {% endcase %} 
        {% endfor %}
          </div>
        {% endform %}
        </div>
      </div>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Product",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_payment_button",
      "label": "Show payment button",
      "default": false
    }
  ],
  "blocks": [
    {
      "type": "title",
      "name": "Title",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title"
        }
      ]
    },
    {
      "type": "price",
      "name": "Price",
      "settings": []
    },
    {
      "type": "inventory",
      "name": "Inventory",
      "settings": []
    },
    {
      "type": "add_to_cart",
      "name": "Add to cart",
      "settings": []
    },
    {
      "type": "variant_picker",
      "name": "Variant picker",
      "settings": []
    },
    {
      "type": "quantity_selector",
      "name": "Quantity selector",
      "settings": []
    }
  ],
  "presets": [
    {
      "name": "Product"
    }
  ]
}
{% endschema %}