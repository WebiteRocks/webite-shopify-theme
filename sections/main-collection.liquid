{%- comment -%} Preload LCP image in document head for early discovery {%- endcomment -%}
{%- if collection.products.first.featured_media -%}
  {%- capture lcp_preload -%}
    <link rel="preload" as="image" fetchpriority="high" href="{{ collection.products.first.featured_media.preview_image | image_url: width: 280 }}" imagesrcset="{{ collection.products.first.featured_media.preview_image | image_url: width: 165 }} 165w, {{ collection.products.first.featured_media.preview_image | image_url: width: 280 }} 280w, {{ collection.products.first.featured_media.preview_image | image_url: width: 330 }} 330w, {{ collection.products.first.featured_media.preview_image | image_url: width: 450 }} 450w, {{ collection.products.first.featured_media.preview_image | image_url: width: 560 }} 560w" imagesizes="(min-width: 960px) 280px, (min-width: 640px) 45vw, 50vw">
  {%- endcapture -%}
  {{ lcp_preload }}
{%- endif -%}

{%- comment -%} Critical CSS inline for faster render {%- endcomment -%}
<style>
  .main-collection__image { aspect-ratio: 1/1; object-fit: cover; background: #f5f5f5; }
  .main-collection__item { contain: layout style paint; }
</style>

{{ 'collection.css' | asset_url | stylesheet_tag }}
<script src="{{ 'collection-filters.js' | asset_url }}" defer></script>

<section class="uk-section uk-section-default" id="collection-section" data-section-id="{{ section.id }}">
  <div class="uk-container">
    <div class="uk-text-center uk-margin-large-bottom">
      <h1 class="uk-heading-medium uk-margin-remove-bottom">{{ collection.title | default: 'All Products' }}</h1>
      {%- if collection.description != blank -%}
        <div class="uk-text-lead uk-text-muted uk-margin-small-top">
          {{ collection.description }}
        </div>
      {%- endif -%}
    </div>

    {%- comment -%} Calculate active filters count {%- endcomment -%}
    {%- assign active_filters_count = 0 -%}
    {%- for filter in collection.filters -%}
      {%- assign active_filters_count = active_filters_count | plus: filter.active_values.size -%}
      {%- if filter.type == 'price_range' -%}
        {%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
          {%- assign active_filters_count = active_filters_count | plus: 1 -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}

    <div class="uk-grid" uk-grid>
      {%- if collection.filters.size > 0 -%}
        <!-- Filters Sidebar (Desktop) - filters moved here via JS on desktop -->
        <aside class="uk-width-1-4@m uk-visible@m collection-filters-container" id="collection-filters-desktop"></aside>
      {%- endif -%}

      <!-- Products Grid -->
      <div class="{% if collection.filters.size > 0 %}uk-width-3-4@m{% else %}uk-width-1-1{% endif %}">
        {% paginate collection.products by section.settings.products_per_page %}
        <div id="collection-product-grid">
          {%- if collection.products.size > 0 -%}
            <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-bottom">
              <p class="uk-text-muted uk-margin-remove" id="collection-product-count">{{ collection.products_count }} products</p>
              {%- if collection.filters.size > 0 -%}
                <button class="uk-button uk-button-default uk-hidden@m" type="button" uk-toggle="target: #mobile-filters">
                  <span uk-icon="settings"></span> Filters
                  {%- if active_filters_count > 0 -%}
                    <span class="uk-badge uk-margin-small-left" id="mobile-filter-badge">{{ active_filters_count }}</span>
                  {%- endif -%}
                </button>
              {%- endif -%}
            </div>
          {%- endif -%}

          <div class="uk-grid uk-grid-medium uk-child-width-1-2 uk-child-width-1-3@m" uk-grid id="collection-products">
            {%- for product in collection.products -%}
              <div{% if forloop.index > 6 %} style="content-visibility: auto; contain-intrinsic-size: auto 400px;"{% endif %}>
                <div class="uk-card uk-card-default uk-card-hover main-collection__item">
                  <div class="uk-card-media-top uk-position-relative" style="aspect-ratio: 1 / 1;">
                    <a href="{{ product.url }}">
                      {%- if product.featured_media -%}
                        {%- if forloop.index <= 3 -%}
                          {{ product.featured_media.preview_image | image_url: width: 560 | image_tag: class: 'main-collection__image uk-width-1-1', loading: 'eager', fetchpriority: 'high', decoding: 'sync', sizes: '(min-width: 960px) 280px, (min-width: 640px) 45vw, 50vw', widths: '165, 280, 330, 450, 560', alt: product.featured_media.alt | default: product.title }}
                        {%- else -%}
                          {{ product.featured_media.preview_image | image_url: width: 560 | image_tag: class: 'main-collection__image uk-width-1-1', loading: 'lazy', decoding: 'async', sizes: '(min-width: 960px) 280px, (min-width: 640px) 45vw, 50vw', widths: '165, 280, 330, 450, 560', alt: product.featured_media.alt | default: product.title }}
                        {%- endif -%}
                      {%- else -%}
                        <div class="main-collection__image main-collection__no-image uk-width-1-1">
                          No Image
                        </div>
                      {%- endif -%}
                    </a>
                    {%- if product.available and product.has_only_default_variant == false -%}
                      <div class="uk-position-cover uk-flex uk-flex-center uk-flex-middle uk-hidden-hover" style="background: rgba(0,0,0,0.3);">
                        <button type="button" class="uk-button uk-button-default uk-button-small" data-quick-view="{{ product.url }}">
                          <span uk-icon="icon: expand; ratio: 0.8"></span> Quick View
                        </button>
                      </div>
                    {%- endif -%}
                    {%- if product.available and section.settings.atc_position == 'hover' -%}
                      <div class="uk-position-bottom uk-position-small uk-hidden-hover">
                        {% render 'product-atc-button', product: product, class: 'uk-button-small' %}
                      </div>
                    {%- endif -%}
                  </div>
                  <div class="uk-card-body uk-padding-small">
                    <a href="{{ product.url }}" class="uk-link-reset">
                      <h3 class="uk-card-title uk-text-small uk-margin-small-bottom">{{ product.title }}</h3>
                      
                      <div class="uk-text-bold uk-text-primary">
                        {%- if product.compare_at_price > product.price -%}
                          <span class="uk-text-muted uk-text-decoration-line-through uk-margin-small-right">{{ product.compare_at_price | money }}</span>
                        {%- endif -%}
                        {{ product.price | money }}
                      </div>
                    </a>
                    {%- if section.settings.atc_position == 'below' -%}
                      <div class="uk-margin-small-top">
                        {% render 'product-atc-button', product: product, class: 'uk-button-small', show_sold_out: true %}
                      </div>
                    {%- endif -%}
                  </div>
                </div>
              </div>
            {%- else -%}
              <div class="uk-width-1-1">
                <div class="uk-text-center uk-padding-large">
                  <p class="uk-text-large uk-text-muted">No products found.</p>
                  {%- if active_filters_count > 0 -%}
                    <a href="{{ collection.url }}" class="uk-button uk-button-default js-filter-clear">Clear all filters</a>
                  {%- endif -%}
                </div>
              </div>
            {%- endfor -%}
          </div>

          {%- comment -%} Pagination {%- endcomment -%}
          <div id="collection-pagination">
            {%- if paginate.pages > 1 -%}
              <nav class="uk-margin-large-top">
                <ul class="uk-pagination uk-flex-center">
                  {%- if paginate.previous -%}
                    <li><a href="{{ paginate.previous.url }}" class="js-pagination-link"><span uk-pagination-previous></span></a></li>
                  {%- endif -%}
                  {%- for part in paginate.parts -%}
                    {%- if part.is_link -%}
                      <li><a href="{{ part.url }}" class="js-pagination-link">{{ part.title }}</a></li>
                    {%- else -%}
                      {%- if part.title == paginate.current_page -%}
                        <li class="uk-active"><span>{{ part.title }}</span></li>
                      {%- else -%}
                        <li class="uk-disabled"><span>{{ part.title }}</span></li>
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- if paginate.next -%}
                    <li><a href="{{ paginate.next.url }}" class="js-pagination-link"><span uk-pagination-next></span></a></li>
                  {%- endif -%}
                </ul>
              </nav>
            {%- endif -%}
          </div>
        </div>
        {% endpaginate %}
      </div>
    </div>
  </div>
</section>

{%- comment -%} Filters - Single instance, moved between desktop sidebar and mobile offcanvas via JS {%- endcomment -%}
{%- if collection.filters.size > 0 -%}
  <div id="collection-filters-wrapper">
    {% render 'collection-filters', collection: collection, active_filters_count: active_filters_count %}
  </div>
  <div id="mobile-filters" uk-offcanvas="overlay: true; flip: true">
    <div class="uk-offcanvas-bar collection-filters-container">
      <button class="uk-offcanvas-close" type="button" uk-close></button>
      <h3>Filters</h3>
      <div id="collection-filters-mobile"></div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Collection Page",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Enable filtering",
      "default": true
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 24
    },
    {
      "type": "header",
      "content": "Product Card"
    },
    {
      "type": "select",
      "id": "atc_position",
      "label": "Add to cart button position",
      "options": [
        {
          "value": "hover",
          "label": "Show on hover"
        },
        {
          "value": "below",
          "label": "Below price"
        },
        {
          "value": "none",
          "label": "Hidden"
        }
      ],
      "default": "hover"
    }
  ]
}
{% endschema %}
