<section class="uk-section uk-section-default" id="collection-section" data-section-id="{{ section.id }}">
  <div class="uk-container">
    <div class="uk-text-center uk-margin-large-bottom">
      <h1 class="uk-heading-medium uk-margin-remove-bottom">{{ collection.title | default: 'All Products' }}</h1>
      {%- if collection.description != blank -%}
        <div class="uk-text-lead uk-text-muted uk-margin-small-top">
          {{ collection.description }}
        </div>
      {%- endif -%}
    </div>

    {%- comment -%} Calculate active filters count {%- endcomment -%}
    {%- assign active_filters_count = 0 -%}
    {%- for filter in collection.filters -%}
      {%- assign active_filters_count = active_filters_count | plus: filter.active_values.size -%}
      {%- if filter.type == 'price_range' -%}
        {%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
          {%- assign active_filters_count = active_filters_count | plus: 1 -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}

    <div uk-grid>
      {%- if collection.filters.size > 0 -%}
        <!-- Filters Sidebar (Desktop) -->
        <aside class="uk-width-1-4@m uk-visible@m">
          <div id="collection-filters-desktop">
            {% render 'collection-filters', collection: collection, active_filters_count: active_filters_count %}
          </div>
        </aside>
      {%- endif -%}

      <!-- Products Grid -->
      <div class="{% if collection.filters.size > 0 %}uk-width-3-4@m{% else %}uk-width-1-1{% endif %}">
        {% paginate collection.products by 12 %}
        <div id="collection-product-grid">
          {%- if collection.products.size > 0 -%}
            <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-bottom">
              <p class="uk-text-muted uk-margin-remove" id="collection-product-count">{{ collection.products_count }} products</p>
              {%- if collection.filters.size > 0 -%}
                <button class="uk-button uk-button-default uk-hidden@m" type="button" uk-toggle="target: #mobile-filters">
                  <span uk-icon="settings"></span> Filters
                  {%- if active_filters_count > 0 -%}
                    <span class="uk-badge uk-margin-small-left" id="mobile-filter-badge">{{ active_filters_count }}</span>
                  {%- endif -%}
                </button>
              {%- endif -%}
            </div>
          {%- endif -%}

          <div class="uk-grid uk-grid-medium uk-child-width-1-2 uk-child-width-1-3@m" uk-grid id="collection-products">
            {%- for product in collection.products -%}
              <div>
                <div class="uk-card uk-card-default uk-card-hover main-collection__item">
                  <div class="uk-card-media-top">
                    <a href="{{ product.url }}">
                      {%- if product.featured_media -%}
                        {% render 'image', 
                            image: product.featured_media.preview_image,
                            image_class: "main-collection__image uk-width-1-1",
                            max_width: 600,
                            max_height: 600,
                            sizes: "(min-width: 600px) 300px, 100vw",
                            widths: "300, 450, 600",
                            loading: forloop.first ? 'eager' : 'lazy',
                            attributes: 'alt="{{ product.featured_media.alt | default: product.title }}"'
                        %}
                      {%- else -%}
                        <div class="main-collection__image main-collection__no-image uk-width-1-1">
                          No Image
                        </div>
                      {%- endif -%}
                    </a>
                  </div>
                  <div class="uk-card-body uk-padding-small">
                    <a href="{{ product.url }}" class="uk-link-reset">
                      <h3 class="uk-card-title uk-text-small uk-margin-small-bottom">{{ product.title }}</h3>
                      
                      <div class="uk-text-bold uk-text-primary">
                        {%- if product.compare_at_price > product.price -%}
                          <span class="uk-text-muted uk-text-decoration-line-through uk-margin-small-right">{{ product.compare_at_price | money }}</span>
                        {%- endif -%}
                        {{ product.price | money }}
                      </div>
                    </a>
                  </div>
                </div>
              </div>
            {%- else -%}
              <div class="uk-width-1-1">
                <div class="uk-text-center uk-padding-large">
                  <p class="uk-text-large uk-text-muted">No products found.</p>
                  {%- if active_filters_count > 0 -%}
                    <a href="{{ collection.url }}" class="uk-button uk-button-default js-filter-clear">Clear all filters</a>
                  {%- endif -%}
                </div>
              </div>
            {%- endfor -%}
          </div>

          {%- comment -%} Pagination {%- endcomment -%}
          <div id="collection-pagination">
            {%- if paginate.pages > 1 -%}
              <nav class="uk-margin-large-top">
                <ul class="uk-pagination uk-flex-center">
                  {%- if paginate.previous -%}
                    <li><a href="{{ paginate.previous.url }}" class="js-pagination-link"><span uk-pagination-previous></span></a></li>
                  {%- endif -%}
                  {%- for part in paginate.parts -%}
                    {%- if part.is_link -%}
                      <li><a href="{{ part.url }}" class="js-pagination-link">{{ part.title }}</a></li>
                    {%- else -%}
                      {%- if part.title == paginate.current_page -%}
                        <li class="uk-active"><span>{{ part.title }}</span></li>
                      {%- else -%}
                        <li class="uk-disabled"><span>{{ part.title }}</span></li>
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- if paginate.next -%}
                    <li><a href="{{ paginate.next.url }}" class="js-pagination-link"><span uk-pagination-next></span></a></li>
                  {%- endif -%}
                </ul>
              </nav>
            {%- endif -%}
          </div>
        </div>
        {% endpaginate %}
      </div>
    </div>
  </div>
</section>

{%- comment -%} Mobile Filters Offcanvas {%- endcomment -%}
{%- if collection.filters.size > 0 -%}
  <div id="mobile-filters" uk-offcanvas="overlay: true; flip: true">
    <div class="uk-offcanvas-bar">
      <button class="uk-offcanvas-close" type="button" uk-close></button>
      <h3>Filters</h3>
      <div id="collection-filters-mobile">
        {% render 'collection-filters', collection: collection, active_filters_count: active_filters_count %}
      </div>
    </div>
  </div>
{%- endif -%}

<style>
  .tm-filter-swatch {
    display: inline-block;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 1px solid #ddd;
    background-size: cover;
  }
  .collection-filters-form .uk-label {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
  }
  .collection-loading {
    opacity: 0.5;
    pointer-events: none;
  }
  .collection-loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    margin: -20px 0 0 -20px;
    border: 3px solid #ddd;
    border-top-color: #333;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  #collection-product-grid {
    position: relative;
    min-height: 200px;
  }
</style>

<script>
  class CollectionFilters {
    constructor() {
      this.filterFormsSelector = '.collection-filters-form';
      this.productGridSelector = '#collection-product-grid';
      this.filtersDesktopSelector = '#collection-filters-desktop';
      this.filtersMobileSelector = '#collection-filters-mobile';
      this.sectionId = '{{ section.id }}';
      
      this.init();
    }

    init() {
      this.bindEvents();
    }

    bindEvents() {
      // Handle checkbox changes (instant filter)
      document.addEventListener('change', (e) => {
        if (e.target.matches('.collection-filters-form input[type="checkbox"]')) {
          this.onFilterChange(e.target.closest('form'));
        }
      });

      // Handle price range input (debounced)
      let priceTimeout;
      document.addEventListener('input', (e) => {
        if (e.target.matches('.collection-filters-form input[type="number"]')) {
          clearTimeout(priceTimeout);
          priceTimeout = setTimeout(() => {
            this.onFilterChange(e.target.closest('form'));
          }, 500);
        }
      });

      // Handle form submit (fallback)
      document.addEventListener('submit', (e) => {
        if (e.target.matches('.collection-filters-form')) {
          e.preventDefault();
          this.onFilterChange(e.target);
        }
      });

      // Handle clear filter links
      document.addEventListener('click', (e) => {
        const clearLink = e.target.closest('.js-filter-clear, .collection-filters-form a[href*="url_to_remove"], .collection-filters-form a[href="{{ collection.url }}"]');
        if (clearLink) {
          e.preventDefault();
          this.fetchAndUpdate(clearLink.href);
        }
        
        // Handle active filter tag removal
        const filterTag = e.target.closest('.collection-filters-form .uk-label[href]');
        if (filterTag) {
          e.preventDefault();
          this.fetchAndUpdate(filterTag.href);
        }

        // Handle pagination
        const paginationLink = e.target.closest('.js-pagination-link');
        if (paginationLink) {
          e.preventDefault();
          this.fetchAndUpdate(paginationLink.href);
          // Scroll to top of products
          document.querySelector('#collection-product-grid')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    onFilterChange(form) {
      const formData = new FormData(form);
      const params = new URLSearchParams();
      
      for (const [key, value] of formData.entries()) {
        if (value) {
          params.append(key, value);
        }
      }
      
      const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      this.fetchAndUpdate(url);
    }

    async fetchAndUpdate(url) {
      const productGrid = document.querySelector(this.productGridSelector);
      
      // Show loading state
      productGrid?.classList.add('collection-loading');

      try {
        // Use Section Rendering API for better performance
        const sectionUrl = url + (url.includes('?') ? '&' : '?') + `sections=${this.sectionId}`;
        
        const response = await fetch(sectionUrl);

        if (!response.ok) throw new Error('Network response was not ok');

        const data = await response.json();
        const html = data[this.sectionId];
        
        if (!html) {
          throw new Error('Section HTML not found in response');
        }
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Update product grid
        const newProductGrid = doc.querySelector(this.productGridSelector);
        if (newProductGrid && productGrid) {
          productGrid.innerHTML = newProductGrid.innerHTML;
        }

        // Update desktop filters
        const newFiltersDesktop = doc.querySelector(this.filtersDesktopSelector);
        const filtersDesktop = document.querySelector(this.filtersDesktopSelector);
        if (newFiltersDesktop && filtersDesktop) {
          filtersDesktop.innerHTML = newFiltersDesktop.innerHTML;
        }

        // Update mobile filters
        const newFiltersMobile = doc.querySelector(this.filtersMobileSelector);
        const filtersMobile = document.querySelector(this.filtersMobileSelector);
        if (newFiltersMobile && filtersMobile) {
          filtersMobile.innerHTML = newFiltersMobile.innerHTML;
        }

        // Update URL without page reload
        history.pushState({}, '', url);

        // Re-initialize UIkit components
        if (typeof UIkit !== 'undefined') {
          UIkit.update();
        }

      } catch (error) {
        console.error('Error fetching filtered products:', error);
        // Fallback to page reload
        window.location.href = url;
      } finally {
        productGrid?.classList.remove('collection-loading');
      }
    }
  }

  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    new CollectionFilters();
  });

  // Handle browser back/forward
  window.addEventListener('popstate', () => {
    window.location.reload();
  });
</script>

{% schema %}
{
  "name": "Collection Page",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Enable filtering",
      "default": true
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 24
    }
  ]
}
{% endschema %}
